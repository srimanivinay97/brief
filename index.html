<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Brief</title>
  <style>
    body{margin:0;font-family:-apple-system,system-ui;background:#0b0b0f;color:#fff}
    .wrap{padding:18px 16px 40px;max-width:560px;margin:0 auto}
    h1{margin:10px 0 18px;font-size:32px;font-weight:800;letter-spacing:-.6px}
    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);
      border-radius:18px;padding:14px 14px;margin:12px 0;backdrop-filter: blur(10px)}
    .muted{opacity:.7;font-size:13px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .big{font-size:38px;font-weight:800;line-height:1}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.10);font-size:13px}
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{padding:10px 0;border-top:1px solid rgba(255,255,255,.10)}
    li:first-child{border-top:0}
    a{color:#9ad}
    .error{background:rgba(255,80,80,.12);border:1px solid rgba(255,80,80,.25)}
    .ok{color:#9f9}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Brief</h1>

    <div id="status" class="card">
      <div class="row">
        <div>
          <div class="muted">Status</div>
          <div id="statusText">Waiting for data…</div>
        </div>
        <div class="pill" id="badge">—</div>
      </div>
      <div class="muted" style="margin-top:8px">
        Tip: open with <span class="pill">?data=BASE64</span>
      </div>
    </div>

    <div id="weatherCard" class="card" style="display:none"></div>
    <div id="eventsCard" class="card" style="display:none"></div>
    <div id="rawCard" class="card" style="display:none"></div>
  </div>

<script>
  function b64ToUtf8(b64){
    // handle URL-safe base64 too
    b64 = b64.replace(/-/g,'+').replace(/_/g,'/');
    // pad
    while (b64.length % 4) b64 += '=';
    const bin = atob(b64);
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return new TextDecoder('utf-8').decode(bytes);
  }

  function deepTrimKeys(obj){
    if (Array.isArray(obj)) return obj.map(deepTrimKeys);
    if (obj && typeof obj === 'object'){
      const out = {};
      for (const [k,v] of Object.entries(obj)){
        out[k.trim()] = deepTrimKeys(v);
      }
      return out;
    }
    return obj;
  }

  function qs(name){
    return new URLSearchParams(location.search).get(name);
  }

  function setStatus(ok, text){
    const status = document.getElementById('status');
    const badge = document.getElementById('badge');
    const st = document.getElementById('statusText');
    st.textContent = text;
    if(ok){
      badge.textContent = "OK";
      badge.className = "pill ok";
      status.classList.remove('error');
    }else{
      badge.textContent = "ERR";
      badge.className = "pill";
      status.classList.add('error');
    }
  }

  function render(data, decodedText){
    // Weather
    const w = data.weather;
    if (w){
      const loc = data.location || "—";
      const temp = w.tempC ?? "—";
      const cond = w.condition ?? "—";
      const wc = document.getElementById('weatherCard');
      wc.style.display = "block";
      wc.innerHTML = `
        <div class="row">
          <div>
            <div class="muted">Weather • ${loc}</div>
            <div class="big">${temp}</div>
            <div class="pill" style="margin-top:10px">${cond}</div>
          </div>
        </div>`;
    }

    // Events
    const ev = data.events;
    if (Array.isArray(ev) && ev.length){
      const ec = document.getElementById('eventsCard');
      ec.style.display = "block";
      ec.innerHTML = `
        <div class="row">
          <div>
            <div class="muted">Today</div>
            <div style="font-size:20px;font-weight:700;margin-top:4px">Events</div>
          </div>
          <div class="pill">${ev.length}</div>
        </div>
        <ul>
          ${ev.map(e => `<li><div class="row">
              <div style="font-weight:650">${e.title ?? "Untitled"}</div>
              <div class="muted">${e.time ?? ""}</div>
          </div></li>`).join("")}
        </ul>`;
    }

    // Raw (optional)
    const rc = document.getElementById('rawCard');
    rc.style.display = "block";
    rc.innerHTML = `
      <div class="muted">Decoded JSON</div>
      <pre style="white-space:pre-wrap;word-break:break-word;margin:10px 0 0;opacity:.9">${decodedText}</pre>
    `;
  }

  (function init(){
    const b64 = qs('data');
    if(!b64){
      setStatus(false, "No data param found.");
      return;
    }

    try{
      const decoded = b64ToUtf8(b64);
      let parsed = JSON.parse(decoded);
      parsed = deepTrimKeys(parsed); // ✅ fixes your “weather ” bug
      setStatus(true, "Data received and parsed.");
      render(parsed, JSON.stringify(parsed, null, 2));
    }catch(e){
      setStatus(false, "Failed to decode/parse: " + e.message);
    }
  })();
</script>
</body>
</html>
